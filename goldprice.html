<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>黃金價格實時趨勢</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Microsoft JhengHei', Arial, sans-serif; }
        body { background: #f5f7fa; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .header h1 { text-align: center; color: #2d3748; font-size: 28px; margin-bottom: 10px; }
        .price-card { display: flex; justify-content: center; gap: 30px; margin-bottom: 30px; flex-wrap: wrap; }
        .price-item { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px 40px; border-radius: 12px; text-align: center; min-width: 220px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .price-item h3 { font-size: 16px; opacity: 0.9; margin-bottom: 8px; }
        .price-item .value { font-size: 28px; font-weight: bold; }
        .chart-container { position: relative; height: 420px; margin: 30px 0; }
        .update-time { text-align: center; color: #888; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>國際黃金價格實時走勢（7天）</h1>
        </div>

        <div class="price-card">
            <div class="price-item">
                <h3>現貨黃金（美元/盎司）</h3>
                <div id="gold-price" class="value">加載中...</div>
            </div>
            <div class="price-item">
                <h3>人民幣價格（元/克）</h3>
                <div id="cn-price" class="value">加載中...</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="gold-chart"></canvas>
        </div>
        <div id="update-info" class="update-time">數據加載中...</div>
    </div>

    <script>
        // 完全免費、無需 Key、長期穩定
        const GOLD_API = "https://goldprice.org/live-gold-price/1-day-gold-price-chart/data.json";
        const EXCHANGE_API = "https://cdn.jsdelivr.net/gh/fawazahmed0/currency-api@1/latest/currencies/usd/cny.json";

        let chartInstance = null;

        // 1. 獲取黃金價格（包含當前 + 過去7天每分鐘數據）
        async function fetchGoldData() {
            try {
                const response = await fetch(GOLD_API + "?t=" + Date.now()); // 防快取
                if (!response.ok) throw new Error("Gold API 失敗");
                const data = await response.json();
                
                // data 結構: [[timestamp, price], ...]
                const now = Date.now();
                const oneWeekAgo = now - 7 * 24 * 60 * 60 * 1000;

                // 過濾最近7天數據並轉為每日收盤價（或最近一點）
                const dailyMap = {};
                data.forEach(([ts, price]) => {
                    if (ts >= oneWeekAgo) {
                        const date = new Date(ts).toISOString().split('T')[0];
                        dailyMap[date] = price;
                    }
                });

                const sortedDates = Object.keys(dailyMap).sort();
                const historicalData = sortedDates.map(date => ({
                    date: date,
                    price: dailyMap[date].toFixed(2)
                }));

                const currentPrice = data[data.length - 1][1];

                return { currentPrice, historicalData };
            } catch (err) {
                console.error(err);
                alert("無法載入黃金價格，請檢查網路或稍後再試");
                return null;
            }
        }

        // 2. 獲取美元兌人民幣匯率（實時）
        async function fetchExchangeRate() {
            try {
                const res = await fetch(EXCHANGE_API + "?t=" + Date.now());
                const data = await res.json();
                return data.cny;
            } catch {
                return 7.18; // 備用匯率
            }
        }

        // 3. 美元/盎司 → 人民幣/克
        function convertToCNY(usdPerOunce, rate) {
            return ((usdPerOunce / 31.1035) * rate).toFixed(2);
        }

        // 4. 繪製圖表
        function renderChart(historicalData, currentPrice) {
            const ctx = document.getElementById('gold-chart').getContext('2d');
            const labels = historicalData.map(d => d.date.slice(5).replace('-', '/')); // MM/DD
            const prices = historicalData.map(d => parseFloat(d.price));

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '黃金價格 (USD/盎司)',
                        data: prices,
                        borderColor: '#f39c12',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#e67e22',
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => `$${ctx.raw.toFixed(2)} / 盎司`
                            }
                        }
                    },
                    scales: {
                        y: { 
                            ticks: { callback: v => '$' + v },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // 5. 主程序
        async function init() {
            document.getElementById('gold-price').textContent = "加載中...";
            document.getElementById('cn-price').textContent = "加載中...";

            const goldData = await fetchGoldData();
            if (!goldData) return;

            const rate = await fetchExchangeRate();
            const cnyPrice = convertToCNY(goldData.currentPrice, rate);

            // 更新價格
            document.getElementById('gold-price').textContent = `$${parseFloat(goldData.currentPrice).toFixed(2)}`;
            document.getElementById('cn-price').textContent = `¥${cnyPrice}`;

            // 補今天數據（如果還沒收盤）
            const today = new Date().toISOString().split('T')[0];
            if (!goldData.historicalData.find(d => d.date === today)) {
                goldData.historicalData.push({
                    date: today,
                    price: goldData.currentPrice.toFixed(2)
                });
            }

            renderChart(goldData.historicalData, goldData.currentPrice);

            // 更新時間
            const time = new Date().toLocaleString('zh-TW', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
            document.getElementById('update-info').textContent = `最後更新：${time}（數據來源：goldprice.org）`;
        }

        // 啟動 + 每5分鐘自動更新
        init();
        setInterval(init, 5 * 60 * 1000);
    </script>
</body>
</html>